name: Build Extension
description: Build the extension and create a zip file

outputs:
  version:
    description: Version extracted from release tag
    value: ${{ steps.extract-version.outputs.version }}
  zip-file:
    description: Path to the created zip file
    value: focus-flow-${{ steps.extract-version.outputs.version }}.zip

runs:
  using: composite
  steps:
    - name: Extract version from release tag
      id: extract-version
      run: |
        # Extract version from tag (e.g., "v1.2.3" -> "1.2.3")
        TAG="${{ github.event.release.tag_name }}"
        VERSION="${TAG#v}"

        if [ -z "$VERSION" ]; then
          echo "❌ Failed to extract version from tag"
          exit 1
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "✅ Extracted version from tag: $VERSION"
      shell: bash

    - name: Configure git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
      shell: bash

    - name: Update manifest.json with release version
      run: |
        VERSION="${{ steps.extract-version.outputs.version }}"
        jq --arg version "$VERSION" '.version = $version' src/manifest.json > src/manifest.json.tmp
        mv src/manifest.json.tmp src/manifest.json
        echo "✅ Updated manifest.json to version $VERSION"
        cat src/manifest.json | jq '.version'
      shell: bash

    - name: Commit manifest.json update
      run: |
        VERSION="${{ steps.extract-version.outputs.version }}"

        # Check if manifest.json was actually changed
        if git diff --quiet src/manifest.json; then
          echo "✅ Manifest already at version $VERSION, no commit needed"
        else
          git add src/manifest.json
          git commit -m "chore: update manifest.json to v$VERSION [skip ci]" || true
          git push origin HEAD:${{ github.event.release.target_commitish }} || echo "⚠️  Could not push manifest update"
        fi
      shell: bash

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci
      shell: bash

    - name: Lint
      run: npm run lint
      shell: bash

    - name: Build extension
      run: npm run build
      shell: bash

    - name: Create dist zip
      run: |
        cd dist
        zip -r "../mindful-browse-${{ steps.extract-version.outputs.version }}.zip" .
        cd ..
        ls -lh mindful-browse-*.zip
      shell: bash
