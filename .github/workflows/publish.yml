name: Publish New Version

on:
  release:
    types: [published]

permissions:
  contents: write  # Allow committing manifest.json updates
  issues: write    # Allow commenting on issues

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.build.outputs.version }}
      zip-file: ${{ steps.build.outputs.zip-file }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build extension
        id: build
        uses: ./.github/actions/build

      - name: Upload zip to release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} ${{ steps.build.outputs.zip-file }}

  publish-firefox:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Publish to Firefox (sign & upload)
        uses: ./.github/actions/publish-to-firefox
        with:
          firefox-api-key: ${{ secrets.FIREFOX_ISSUER }}
          firefox-api-secret: ${{ secrets.FIREFOX_SECRET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  publish-chrome:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Publish to Chrome Web Store
        uses: ./.github/actions/publish-to-chrome
        with:
          chrome-client-id: ${{ secrets.CHROME_CLIENT_ID }}
          chrome-client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          chrome-refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          chrome-extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          zip-file: ${{ needs.build.outputs.zip-file }}
          publish: 'true'
        continue-on-error: true

  deploy-status:
    runs-on: ubuntu-latest
    needs: [build, publish-firefox, publish-chrome]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.build.outputs.version }}';
            const buildStatus = '${{ needs.build.result }}';
            const firefoxStatus = '${{ needs.publish-firefox.result }}';
            const chromeStatus = '${{ needs.publish-chrome.result }}';

            const statusEmoji = (status) => status === 'success' ? 'âœ…' : status === 'failure' ? 'âŒ' : 'âš ï¸';

            const message = `ðŸš€ Release v${version} deployment completed!\n\n` +
              `**Build Status:**\n` +
              `${statusEmoji(buildStatus)} Extension built and zipped\n\n` +
              `**Store Submissions:**\n` +
              `${statusEmoji(firefoxStatus)} Firefox: Signing and submitting to AMO\n` +
              `${statusEmoji(chromeStatus)} Chrome: Uploading to Web Store\n\n` +
              `**Next Steps:**\n` +
              `- Firefox: Review typically takes 2-5 days\n` +
              `- Chrome: Review typically takes 1-3 hours\n\n` +
              `Check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for detailed status.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            }).catch(() => {
              console.log('No associated issue for comment');
            });
